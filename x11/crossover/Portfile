# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0

name                    CrossOver

version                 21.2.0
revision                0

categories              x11
platforms               darwin
license                 Commercial
maintainers             {@gcenx}

supported_archs         x86_64
description             CodeWeavers commercial version of wine

long_description        ${name} runs thousands of different Windows apps \
                        on your Mac. From productivity, utility, games, \
                        and design software-Windows software never looked \
                        better when launched right from the macOS dock with \
                        {name} Mac. Easily switch between Mac or Windows \
                        programs without rebooting, without using a virtual \
                        machine and without purchasing a Windows license. \
                        The best solution to run Windows programs on Mac \
                        is with native functionality like copy & paste, \
                        keyboard shortcuts, Mission Control, and more!

homepage                https://www.codeweavers.com/products/crossover-mac/

master_sites            https://media.codeweavers.com/pub/crossover/cxmac/demo/
distname                crossover-${version}
use_zip                 yes

checksums               rmd160  1707937446006d44611dac97f4efca137ebdf755 \
                        sha256  94eb363bd9bdced95548e858922d262ca3f70156ab9dba3d687eb2fa28bdbae0 \
                        size    355797834

use_configure           no

depends_lib             port:ncurses

build {
    # Remove these to avoid gatekeeper crying, due to needed modifications (rev-upgrade)
    delete ${workpath}/CrossOver.app/Contents/CodeResources
    delete ${workpath}/CrossOver.app/Contents/_CodeSignature

    # Remove CrossOver CD Helper
    delete "${workpath}/CrossOver.app/Contents/Resources/CrossOver CD Helper.app"

    # Can't remove Sparkle.framework so remove the update url
    reinplace s|https://www.codeweavers.com/xml/versions/cxmac.xml||g ${workpath}/CrossOver.app/Contents/Info.plist

    # Fix for macOS Ventura
    delete ${workpath}/CrossOver.app/Contents/Resources/libcxsetupbase.py
    xinstall -m 0644 ${filespath}/libcxsetupbase.py ${workpath}/CrossOver.app/Contents/Resources/libcxsetupbase.py

    # Fix vkd3d-compiler (rev-upgrade)
    system -W ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/bin \
        "install_name_tool -change /opt/cxoffice/lib64/libvkd3d-shader.1.dylib @rpath/libvkd3d-shader.1.dylib ./vkd3d-compiler"
    system -W ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/bin \
        "install_name_tool -change /opt/local/lib/libncurses.6.dylib @rpath/libncurses.6.dylib ./vkd3d-compiler"
    # Add rpath
    system -W ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/bin \
        "install_name_tool -add_rpath @loader_path/../lib64 ./vkd3d-compiler"
    system -W ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/bin \
        "install_name_tool -add_rpath @loader_path/${prefix}/lib ./vkd3d-compiler"

    # Fix d3d12.dll.so (rev-upgrade)
    system -W ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/lib64/wine \
        "install_name_tool -change /opt/cxoffice/lib64/libvkd3d.1.dylib @rpath/libvkd3d.1.dylib ./d3d12.dll.so"
    # Add rpath
    system -W ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/lib64/wine \
        "install_name_tool -add_rpath @loader_path/../ ./d3d12.dll.so"
}

variant mod description {Update DXVK & MoltenVK} {
    depends_lib-append  port:MoltenVK \
                        port:wine-gecko \
                        port:wine-mono-7.0.0 \
                        port:x86_64-w64-mingw32-dxvk

    post-build {
        # Replace icon
        delete ${workpath}/CrossOver.app/Contents/Resources/CrossOver.icns
        xinstall -m 0644 ${filespath}/CrossOver.icns ${workpath}/CrossOver.app/Contents/Resources/CrossOver.icns

        # Add required MoltenVK env options to cxbottle.conf template
        system "echo MVK_CONFIG_FULL_IMAGE_VIEW_SWIZZLE=1 >> ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/share/crossover/bottle_data/cxbottle.conf"
        system "echo MVK_ALLOW_METAL_FENCES=1 >> ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/share/crossover/bottle_data/cxbottle.conf"
        system "echo MVK_CONFIG_RESUME_LOST_DEVICE=1 >> ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/share/crossover/bottle_data/cxbottle.conf"
        system "echo DXVK_HUD=devinfo,fps,version >> ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/share/crossover/bottle_data/cxbottle.conf"

        # Use port:MoltenVK
        delete ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/lib64/libMoltenVK.dylib
        ln -sf ${prefix}/lib/libMoltenVK.dylib ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/lib64/libMoltenVK.dylib

        # Use port:wine-gecko
        delete ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/share/wine/gecko
        ln -sf ${prefix}/share/wine/gecko ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/share/wine/gecko

        # Use port:wine-mono-7.0.0
        delete ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/share/wine/mono
        ln -sf ${prefix}/share/wine/mono ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/share/wine/mono

        # Use port:x86_64-w64-mingw32-dxvk
        delete ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/lib64/wine/dxvk
        ln -sf ${prefix}/share/wine/dxvk/x64 ${workpath}/CrossOver.app/Contents/SharedSupport/CrossOver/lib64/wine/dxvk
    }

    notes "
        $subport has been modified don't ask CodeWeavers for support
    "
}

destroot {
    copy ${workpath}/CrossOver.app ${destroot}${applications_dir}/CrossOver.app
}

platform darwin {
    if {${os.major} < 17} {
        archive_sites
        distfiles
        depends_build
        pre-fetch {
            ui_error "${name} @${version} requires macOS High Sierra or later"
            return -code error "incompatible macOS version"
        }
    }
}
