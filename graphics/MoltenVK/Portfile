# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
PortGroup                   github 1.0

github.setup                gcenx MoltenVK 1.1.8 v
github.tarball_from         releases

categories                  graphics
maintainers                 {@gcenx}
platforms                   macosx
license                     Apache-2

supported_archs             arm64 x86_64

description                 an implementation of Vulkan for Metal

long_description            ${name} is an implementation of the high-performance, \
                            industry-standard Vulkan graphics and compute API, that \
                            runs on Apple's Metal graphics framework.

dist_subdir                 MoltenVK
use_xz                      yes

if {${subport} eq ${name}} {
    conflicts               MoltenVK-CX MoltenVK-DXVK
    revision                0

    distname                macos-${version}
    checksums               rmd160  58c82ca7464b7652b992b1706bab34802e45f68f \
                            sha256  cda4878b7e1b278a27a7b7b65c71e8d212f97a98b92fb9db614eacf4052565bd \
                            size    9324092
}

subport ${name}-CX {
    github.setup            gcenx MoltenVK 1.1.3 v
    conflicts               MoltenVK MoltenVK-DXVK
    revision                0

    distname                macos_cx21
    checksums               rmd160  7bfc2dd9486aa463587e0f224f3c00e3cc9abf7b \
                            sha256  60ec242207f2d139600d66c6ded65e942f8e50de54d7159de185479ca56e543c \
                            size    8500388
}

subport ${name}-DXVK {
    conflicts               MoltenVK MoltenVK-CX
    revision                0

    distname                macos_dxvk_patched-${version}
    checksums               rmd160  80c2fe044f5a885158904ccd86c1e62fd72d7971 \
                            sha256  52d9967d7dffd583105e6100d35b344a6e36f96a111b472cebf2da530023dad9 \
                            size    9324576
}

# Placed here we can override the version
master_sites                https://github.com/${github.author}/${github.project}/${github.tarball_from}/download/v${version}

use_configure               no
build                       {}

destroot {
    set output_dir ${workpath}/Package/Release/MoltenVK
    file copy ${output_dir}/dylib/macOS/libMoltenVK.dylib ${destroot}${prefix}/lib

    # Xcode11 and later are required to use "xcframework"
    # Headers currently break build due to Xcode 12 ProcessXCFramework bug:
    # https://developer.apple.com/forums/thread/651043?answerId=628400022#628400022
    if {${os.major} >= 18} {
        file copy ${output_dir}/MoltenVK.xcframework ${destroot}${frameworks_dir}
    }

    if {${os.major} < 20} {
        # Turn the dylib into a single arch for lower macOS versions
        system -W ${destroot}${prefix}/lib "lipo -thin x86_64 libMoltenVK.dylib -o libMoltenVK.dylib 2> /dev/null"
    }
}

platform darwin {
    if {${os.major} < 15} {
        archive_sites
        distfiles
        depends_build
        pre-fetch {
            ui_error "${subport} @${version} requires macOS El Capitan or later"
            return -code error "incompatible OS X version"
        }
    }
}
