# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
PortGroup                   github 1.0

github.setup                The-Wineskin-Project MoltenVK 1.2.0 v
github.tarball_from         releases

categories                  graphics
maintainers                 {@gcenx}
platforms                   macosx
license                     Apache-2

supported_archs             arm64 x86_64

description                 an implementation of Vulkan for Metal

long_description            ${name} is an implementation of the high-performance, \
                            industry-standard Vulkan graphics and compute API, that \
                            runs on Apple's Metal graphics framework.

dist_subdir                 MoltenVK
use_xz                      yes

if {${subport} eq ${name}} {
    conflicts               MoltenVK-CX
    revision                0

    distname                macos-${version}
    checksums               rmd160  415e49766421b4955b6ad60de4f28645d7b31cbb \
                            sha256  7b2160ba9d24ca7e8b277a8edb19e43710946934fd137714fe8695b3114d93f1 \
                            size    9735388
}

subport ${name}-CX {
    github.setup            gcenx MoltenVK 1.1.10 v
    conflicts               MoltenVK
    revision                0

    distname                macos_cx22
    checksums               rmd160  014f97b0c529f1c43d31a3b01e61b6882c9ac72c \
                            sha256  3816dbed07643de78467767836b88f02dafcb0fbddfc4fe10e3fbf80a0b3a0be \
                            size    9394524
}

# Placed here we can override the version
master_sites                https://github.com/${github.author}/${github.project}/${github.tarball_from}/download/v${version}

use_configure               no
build                       {}

destroot {
    set output_dir ${workpath}/Package/Release/MoltenVK
    file copy ${output_dir}/dylib/macOS/libMoltenVK.dylib ${destroot}${prefix}/lib

    # Xcode11 and later are required to use "xcframework"
    # Headers currently break build due to Xcode 12 ProcessXCFramework bug:
    # https://developer.apple.com/forums/thread/651043?answerId=628400022#628400022
    if {${os.major} >= 18} {
        file copy ${output_dir}/MoltenVK.xcframework ${destroot}${frameworks_dir}
    }

    if {[variant_exists universal] && [variant_isset universal] || ${os.major} < 20} {
        # Turn the dylib into a single arch for lower macOS versions
        system -W ${destroot}${prefix}/lib "lipo -thin ${build.arch} libMoltenVK.dylib -o libMoltenVK.dylib 2> /dev/null"
    }
}

platform darwin {
    if {${os.major} < 15} {
        known_fail yes
        archive_sites
        distfiles
        depends_build
        depends_lib
        pre-fetch {
            ui_error "${subport} @${version} requires macOS El Capitan or later"
            return -code error "incompatible OS X version"
        }
    }
}
