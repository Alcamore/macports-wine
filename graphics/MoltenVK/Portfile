# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
categories                  graphics
maintainers                 openmaintainer
license                     Apache-2

supported_archs             arm64 x86_64

platforms                   darwin
description                 an implementation of Vulkan for Metal
name                        MoltenVK
conflicts                   MoltenVK-CX MoltenVK-DXVK VulkanSDK
set my_name                 MoltenVK

long_description            ${name} is an implementation of the high-performance, \
                            industry-standard Vulkan graphics and compute API, that \
                            runs on Apple's Metal graphics framework.

# MoltenVK version from https://github.com/Gcenx/MoltenVK/releases
version                     1.1.6

subport MoltenVK {
    name                    MoltenVK
    conflicts               MoltenVK-CX MoltenVK-DXVK VulkanSDK
    set my_name             MoltenVK
    revision                0
    use_xz                  yes
    extract.suffix          .tar.xz
    distname                macos-${version}${extract.suffix}
    distfiles               ${distname}

    checksums               rmd160  995023832d778a7298d8b1ab9fb1afd0bbd24ec7 \
                            sha256  0ea92557314e961efaadde3b005f63576874b32769c2fe9b672e8ee2440fa0f3 \
                            size    9172156
}

# Useful for avoiding the annoying "GPU lost" issue when using DXVK
subport MoltenVK-CX {
    name                    MoltenVK-CX
    conflicts               MoltenVK MoltenVK-DXVK VulkanSDK
    set my_name             MoltenVK-CX
    version                 1.1.3
    revision                0
    use_xz                  yes
    extract.suffix          .tar.xz
    distname                macos_cx21${extract.suffix}
    distfiles               ${distname}

    checksums               rmd160  7bfc2dd9486aa463587e0f224f3c00e3cc9abf7b \
                            sha256  60ec242207f2d139600d66c6ded65e942f8e50de54d7159de185479ca56e543c \
                            size    8500388
}

subport MoltenVK-DXVK {
    name                    MoltenVK-DXVK
    conflicts               MoltenVK MoltenVK-CX VulkanSDK
    set my_name             MoltenVK-DXVK
    revision                0
    use_xz                  yes
    extract.suffix          .tar.xz
    distname                macos_dxvk_patched-${version}${extract.suffix}
    distfiles               ${distname}

    checksums               rmd160  b5cfcd4c586e11ded27f89249298e671512ab8e1 \
                            sha256  f211973258812982d21c8ac5e21c1746287e18d560de3db3f7eacdaf761686d9 \
                            size    9176884
}

# Avoid distfiles conflicting
dist_subdir                 MoltenVK

# Placed here so VulkanSDK can override the url
master_sites                https://github.com/Gcenx/MoltenVK/releases/download/v${version}

subport VulkanSDK {
    name                    VulkanSDK
    conflicts               MoltenVK MoltenVK-CX MoltenVK-DXVK
    set my_name             VulkanSDK
    dist_subdir             MoltenVK
    version                 1.2.170.0
    distname                vulkansdk-macos-${version}
    use_dmg                 yes

    master_sites            https://sdk.lunarg.com/sdk/download/${version}/mac/

    checksums               sha256  5c7264a66c57918f617d2b62dc062fd8c0a671915819b4c9420cd431e7808729 \
                            rmd160  fff4feeea5ee769efcf5537318f1a99415b739fb \
                            size    492395748
}

use_configure               no
build                       {}

destroot {
    if {${subport} eq {VulkanSDK}} {
        set output_dir ${worksrcpath}/macOS
        file delete -force ${destroot}${prefix}/bin
        file copy ${output_dir}/bin ${destroot}${prefix}
        file copy ${output_dir}/Frameworks/vulkan.framework ${destroot}${frameworks_dir}
        file copy ${worksrcpath}/MoltenVK/MoltenVK.xcframework ${destroot}${frameworks_dir}
        file delete -force ${destroot}${prefix}/lib
        file copy ${output_dir}/lib ${destroot}${prefix}
        file delete -force ${destroot}${prefix}/include
        file copy ${output_dir}/include ${destroot}${prefix}
        file delete -force ${destroot}${prefix}/share
        file copy ${output_dir}/share ${destroot}${prefix}
        reinplace "s|../../..|${prefix}|g" ${destroot}${prefix}/share/vulkan/icd.d/MoltenVK_icd.json \
                                           ${destroot}${prefix}/share/vulkan/explicit_layer.d/VkLayer_api_dump.json \
                                           ${destroot}${prefix}/share/vulkan/explicit_layer.d/VkLayer_khronos_validation.json
        reinplace "s|/Users/lunarg/Dev/macos-sdk-build/SPIRV-Cross/build/install|${prefix}|g" ${destroot}${prefix}/lib/pkgconfig/spirv-cross-c-shared.pc
        reinplace "s|/Users/lunarg/Dev/macos-sdk-build/Glslang/build/install|${prefix}|g" ${destroot}${prefix}/lib/pkgconfig/SPIRV-Tools-shared.pc
        reinplace "s|/Users/lunarg/Dev/macos-sdk-build/Glslang/build/install|${prefix}|g" ${destroot}${prefix}/lib/pkgconfig/SPIRV-Tools.pc
    } else {
        set output_dir ${workpath}/Package/Release/MoltenVK
        file copy ${output_dir}/dylib/macOS/libMoltenVK.dylib ${destroot}${prefix}/lib
        if {${os.major} < 20} {
            # Turn the dylib into a single arch for lower macOS versions
            system "cd ${destroot}${prefix}/lib && lipo -thin x86_64 libMoltenVK.dylib -o libMoltenVK.dylib 2> /dev/null"
        }
        file copy ${output_dir}/MoltenVK.xcframework ${destroot}${frameworks_dir}
    }
}

platform darwin {
    if {${os.major} < 15} {
        archive_sites
        distfiles
        depends_build
        pre-fetch {
            ui_error "${subport} @${version} requires macOS El Capitan or later"
            return -code error "incompatible OS X version"
        }
    }
}
